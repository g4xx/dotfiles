#!/usr/bin/env bash

set -euo pipefail

# --- Detect current mode ---
current_mode=$(supergfxctl -g 2>/dev/null || supergfxctl --get 2>/dev/null || true)

if [[ -z "$current_mode" ]]; then
    notify-send "GPU Toggle" "Could not determine current GPU mode. Is supergfxctl running?" --icon=error
    exit 1
fi

current_mode=$(echo "$current_mode" | grep -oE 'Integrated|Hybrid' | head -n1)

# --- Determine target mode ---
if [[ "$current_mode" == "Integrated" ]]; then
    target_mode="Hybrid"
else
    target_mode="Integrated"
fi

# --- Show confirmation with swaynag ---
swaynag -t warning \
    -m "Switch GPU mode from $current_mode â†’ $target_mode? (This will log you out)" \
    -B "Confirm" "bash -c 'notify-send \"GPU Toggle\" \"Switching to $target_mode mode...\" && supergfxctl -m $target_mode && sleep 1 && swaymsg exit'" \
    -b "Cancel" "notify-send \"GPU Toggle\" \"Cancelled.\""

